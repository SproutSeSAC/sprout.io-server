# This is a basic workflow that is manually triggered

name: Deploy 🚀

on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Git Clone
      - name: Checkout
        uses: actions/checkout@v2

      # 2. Set up JDK 17
      - name: Setup JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle 빌드
      - name: Build Project with Gradle
        run: ./gradlew clean build

      # 4. 도커파일 생성... 차후 레포 내 파일로 변경
      - name: Create Dockerfile
        run: |
          echo "FROM amazoncorretto:17-alpine" > Dockerfile
          echo "COPY build/libs/api-0.0.1-SNAPSHOT.jar /app.jar" >> Dockerfile
          echo "ENTRYPOINT [\"java\", \"-jar\", \"/app.jar\"]" >> Dockerfile

      # 5. AWS CLI 설치
      - name: Install or Update AWS CLI
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          
          INSTANCE_PUBLIC_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=Sprout-EC2" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text \
            --region ap-northeast-2)
          echo "EC2_PUBLIC_IP=${INSTANCE_PUBLIC_IP}" >> $GITHUB_ENV

      # 6. SSH 키 설정
      - name: Configure SSH Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ssh_key.pem
          chmod 600 ssh_key.pem

      # 6. EC2
      - name: Deploy 🚀🚀🚀
        env:
          EC2_PUBLIC_IP: ${{ env.EC2_PUBLIC_IP }}
        run: |
          scp -o StrictHostKeyChecking=no -i ssh_key.pem Dockerfile ubuntu@${EC2_PUBLIC_IP}:/home/ubuntu/
          scp -o StrictHostKeyChecking=no -i ssh_key.pem build/libs/api-0.0.1-SNAPSHOT.jar ubuntu@${EC2_PUBLIC_IP}:/home/ubuntu/

          ssh -o StrictHostKeyChecking=no -i ssh_key.pem ubuntu@${EC2_PUBLIC_IP} << 'EOF'
          if docker ps | grep -q "spring-boot-container"; then
            echo "Stopping existing container..."
            docker stop spring-boot-container
            docker rm spring-boot-container
          fi

          if docker images | grep -q "spring-boot-app"; then
            echo "Removing existing image..."
            docker rmi spring-boot-app:latest
          fi

          echo "Building new Docker image..."
          docker build -t spring-boot-app:latest /home/ubuntu/
          
          echo "Running new container..."
          docker run -d --name spring-boot-container -p 8080:8080 spring-boot-app:latest
          EOF
